<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
  <meta charset="utf-8">
  
  <title>
    
    SQL语句如何优化及案例分析？
    
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/logo.png" type="image/svg+xml" />

  <!-- lightgallery查看图片支持 -->
  
<link rel="stylesheet" href="/js/lightgallery/lightgallery.css">

  
<script src="/js/lightgallery/lightgallery.min.js"></script>

  
<script src="/js/lightgallery/lg-zoom.min.js"></script>

  
<script src="/js/lightgallery/lg-fullscreen.min.js"></script>

  
<script src="/js/lightgallery/lg-thumbnail.min.js"></script>

  
  <!-- 活动图支持 -->
  
<script src="/js/echart/echarts-4.8.0.min.js"></script>


  <!-- 思维导图支持 -->
  
<script src="/js/markmap/d3@6.js"></script>

  
<script src="/js/markmap/markmap-view@0.2.7.js"></script>

  
<link rel="stylesheet" href="/js/markmap/katex.min.css">

  
<link rel="stylesheet" href="/js/markmap/custom-markmap.css">

  
  <!-- 字体支持 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Consolas&family=Noto+Sans+SC:wght@300&display=swap.css" rel="stylesheet">
  
<link rel="stylesheet" href="/iconfont/iconfont.css">

  
  <!-- 代码高亮支持 -->
  
<script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/prism/1.17.1/prism.min.js"></script>

  
<script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/prism/1.17.1/plugins/autoloader/prism-autoloader.min.js"></script>

  
<script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/prism/1.17.1/plugins/line-numbers/prism-line-numbers.min.js"></script>

  
<link rel="stylesheet" href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/prism/1.17.1/plugins/line-numbers/prism-line-numbers.min.css">

  
<link rel="stylesheet" href="/css/prism/material-light.css">

  
<link rel="stylesheet" href="/css/prism/material-dark.css">


  <!-- 自定义样式 -->
  
<link rel="stylesheet" href="/css/style.css">


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
  <div class="layout-container">
    <header>
  <a href="/"><img class="header-logo" src="/logo.png"/></a>
  <h3>xuMengqi&#39;s Blog</h3>
  <ul class="header-nav">
    <li class="header-nav-child">
      <a href="/">首页</a>
    </li>
    <li class="header-nav-child">
      <a href="/categories">分类</a>
    </li>
    <li class="header-nav-child">
      <a href="/tags">标签</a>
    </li>
    <li class="header-nav-child">
      <a href="/about">关于我</a>
    </li>
    <li class="header-nav-child">
      <img class="header-theme-switcher" onclick="switchTheme()"  src="/img/dark-mode.svg"/>
    </li>
  </ul>
  <img class="header-to-top" onclick="scrollToTop()" src="/img/top.svg"/>
<script>
  function scrollToTop() {
    document.body.scrollTop = 0; // 对Safari
    document.documentElement.scrollTop = 0; // 对Chrome, Firefox, IE 和 Opera
  }
  
  function setThemeMode(mode) {
    localStorage.setItem('theme-mode', mode)
  }

  function getThemeMode() {
    return localStorage.getItem('theme-mode')
  }

  function switchTheme() {
    let themeMode = getThemeMode()
    if (themeMode === 'light') {
      document.documentElement.className = 'dark'
      document.getElementsByClassName('header-theme-switcher')[0].src = "/img/light-mode.svg"
      setThemeMode('dark')
    } else {
      document.documentElement.className = 'light'
      document.getElementsByClassName('header-theme-switcher')[0].src = "/img/dark-mode.svg"
      setThemeMode('light')
    }
  }
  
  // 开启主题
  if (getThemeMode() === null) {
	  switchTheme()
  }
  if (getThemeMode() === 'dark') {
    setThemeMode('light')
    switchTheme()
  }
  

  
  var prevScrollpos = window.pageYOffset;
  /* Get the header element and it's position */
  var headerDiv = document.getElementsByTagName("header")[0];
  var headerBottom = headerDiv.offsetTop + headerDiv.offsetHeight;
  window.onscroll = function() {
    var currentScrollPos = window.pageYOffset;
    /* if scrolling down, let it scroll out of view as normal */
    if (prevScrollpos <= currentScrollPos ){
        headerDiv.style.top ="-6rem";
    }
    /* otherwise if we're scrolling up, fix the nav to the top */
    else{  
        headerDiv.style.top = "0";
    }
    prevScrollpos = currentScrollPos;
  }
</script>
</header>
    <main class="main-post">
  <div class="toc-container">
  <div class="toc-toggle">
    <i id="toc-b-icon" class="iconfont icon-liebiao-01" onclick="toggleShow()"></i>
  </div>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">1. 背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%BC%98%E5%8C%96SQL%E8%AF%AD%E5%8F%A5%EF%BC%9F"><span class="toc-text">1.1. 为什么需要优化SQL语句？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9A%E4%BD%8D%E5%B9%B6%E4%BC%98%E5%8C%96%E6%85%A2%E7%9A%84SQL%E8%AF%AD%E5%8F%A5%EF%BC%9F"><span class="toc-text">1.2. 如何定位并优化慢的SQL语句？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">1.3. 环境准备</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-text">2. 执行计划</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8BSQL%E8%AF%AD%E5%8F%A5%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%EF%BC%9F"><span class="toc-text">2.1. 如何查看SQL语句的执行计划？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#select-type"><span class="toc-text">2.2. select_type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#type"><span class="toc-text">2.3. type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filtered"><span class="toc-text">2.4. filtered</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Extra"><span class="toc-text">2.5. Extra</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL%E8%AF%AD%E5%8F%A5%E4%BC%98%E5%8C%96%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-text">3. SQL语句优化案例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-text">3.1. 查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%85%B7%E4%BD%93%E5%AD%97%E6%AE%B5%E4%BB%A3%E6%9B%BFselect"><span class="toc-text">3.1.1. 使用具体字段代替select *</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8union-all%E4%BB%A3%E6%9B%BFunion"><span class="toc-text">3.1.2. 使用union all代替union</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%AF%BC%E8%87%B4%E5%85%A8%E8%A1%A8%E6%89%AB%E6%8F%8F"><span class="toc-text">3.1.3. 避免索引失效导致全表扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E6%8F%90%E9%AB%98order-by%E7%9A%84%E6%95%88%E7%8E%87"><span class="toc-text">3.1.4. 使用索引提高order by的效率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E6%8F%90%E9%AB%98group-by%E7%9A%84%E6%95%88%E7%8E%87"><span class="toc-text">3.1.5. 使用索引提高group by的效率</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E4%BC%98%E5%8C%96"><span class="toc-text">3.2. 连接优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#join%E4%BD%BF%E7%94%A8%E5%B0%8F%E8%A1%A8%E9%A9%B1%E5%8A%A8%E5%A4%A7%E8%A1%A8"><span class="toc-text">3.2.1. join使用小表驱动大表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#join%E7%9A%84%E8%A1%A8%E4%B8%8D%E5%AE%9C%E8%BF%87%E5%A4%9A"><span class="toc-text">3.2.2. join的表不宜过多</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BAjoin%E7%9A%84%E5%85%B3%E8%81%94%E6%9D%A1%E4%BB%B6%E5%BB%BA%E7%AB%8B%E7%B4%A2%E5%BC%95"><span class="toc-text">3.2.3. 为join的关联条件建立索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%BC%98%E5%8C%96"><span class="toc-text">3.3. 业务优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96"><span class="toc-text">3.3.1. 深分页优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-text">4. 参考文档</span></a></li></ol>
</div>

<script>
  var show = false
  function toggleShow() {
    if (show) {
      document.getElementsByClassName('toc')[0].className = 'toc'
      document.getElementById('toc-b-icon').className = 'iconfont icon-liebiao-01'
    } else {
      document.getElementsByClassName('toc')[0].className = 'toc show'
      document.getElementById('toc-b-icon').className = 'iconfont icon-quxiao-01'
    }
    show = !show
  }
  document.getElementsByClassName('toc')[0].onclick = toggleShow
</script>

  <div class="article-header">
    <div class="article-tags">
      
        <a class="article-tags-version" href="/categories/MySQL">> MySQL</a>
      
      
      <a href="/tags/总结">总结</a>
      
      <a href="/tags/图解">图解</a>
      
    </div>
    <div class="article-title">
      <h1>SQL语句如何优化及案例分析？</h1>
    </div>
    <div class="article-details">
      <div class="article-post-date">
        <span>作者：徐梦旗，发布于：2024-03-19 20:00，字数：4.4k，预计阅读：22分钟</span>
	    </div>
    </div>
  </div>
  <div class="article">
  
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" type="text/css" href><div class=".article-gallery"><blockquote>
<p>数据库调优的手段有数据库层面、表层面和SQL语句层面，本文主要探究在SQL语句层面如何进行调优。本文的测试环境为MySQL8.0.34。</p>
</blockquote>
<h2 id="背景">1. 背景</h2><h3 id="为什么需要优化SQL语句？">1.1. 为什么需要优化SQL语句？</h3><ul>
<li>从开发人员的角度来说，优化SQL语句是为了能够支撑更大的数据量，提供更快性能更好的业务接口。</li>
<li>从用户的角度来说，优化SQL语句是为了给用户提供更好的服务，如更低的响应时间（RT）和更高的每秒事务处理数（TPS）。</li>
</ul>
<h3 id="如何定位并优化慢的SQL语句？">1.2. 如何定位并优化慢的SQL语句？</h3><ol>
<li>保持良好的习惯，在每编写完一条SQL语句后都分析下该语句的执行计划，以评估该语句的查询速度，排查潜在的性能问题。</li>
<li>开启MySQL数据库的慢查询日志，以便记录在生产环境中执行较慢的SQL语句，方便排查问题。</li>
</ol>
<blockquote>
<p>慢查询日志参数：</p>
<ul>
<li>可以通过<code>slow_query_log</code>参数开启慢查询日志。</li>
<li>可以通过<code>slow_query_log_file</code>参数指定慢查询日志的路径。</li>
<li>可以通过<code>long_query_time</code>参数指定慢查询的查询时间阈值。</li>
<li>可以通过<code>log_queries_not_using_indexes</code>参数开启记录未使用到索引的查询。</li>
</ul>
</blockquote>
<h3 id="环境准备">1.3. 环境准备</h3><p>本文使用的测试表<code>user</code>的表结构如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">CREATE TABLE &#96;user&#96; (
  &#96;id&#96; bigint NOT NULL COMMENT &#39;ID&#39;,
  &#96;name&#96; varchar(100) DEFAULT NULL COMMENT &#39;姓名&#39;,
  &#96;id_no&#96; varchar(50) DEFAULT NULL COMMENT &#39;证件号码&#39;,
  &#96;mobile&#96; varchar(20) DEFAULT NULL COMMENT &#39;手机号&#39;,
  &#96;job&#96; varchar(100) DEFAULT NULL COMMENT &#39;职业&#39;,
  &#96;country&#96; varchar(100) DEFAULT NULL COMMENT &#39;国家&#39;,
  &#96;city&#96; varchar(100) DEFAULT NULL COMMENT &#39;城市&#39;,
  &#96;address&#96; varchar(255) DEFAULT NULL COMMENT &#39;地址&#39;,
  &#96;email&#96; varchar(100) DEFAULT NULL COMMENT &#39;邮箱&#39;,
  &#96;salary&#96; bigint DEFAULT NULL COMMENT &#39;薪资&#39;,
  &#96;create_time&#96; datetime DEFAULT NULL COMMENT &#39;创建时间&#39;,
  &#96;modify_time&#96; datetime DEFAULT NULL COMMENT &#39;修改时间&#39;,
  PRIMARY KEY (&#96;id&#96;),
  UNIQUE KEY &#96;uk_id_no&#96; (&#96;id_no&#96;),
  KEY &#96;idx_job&#96; (&#96;job&#96;),
  KEY &#96;idx_country_city&#96; (&#96;country&#96;,&#96;city&#96;),
  KEY &#96;idx_create_time&#96; (&#96;create_time&#96;)
) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4 COLLATE&#x3D;utf8mb4_general_ci</code></pre>


<h2 id="执行计划">2. 执行计划</h2><h3 id="如何查看SQL语句的执行计划？">2.1. 如何查看SQL语句的执行计划？</h3><p>可以通过<code>EXPLAIN</code><sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[MySQL :: MySQL 8.0 Reference Manual :: 10.8.2 EXPLAIN Output Format](https://dev.mysql.com/doc/refman/8.0/en/explain-output.html)
">[1]</span></a></sup>命令来查看SQL语句的执行计划，如下图：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user where id &#x3D; 1;
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | user  | NULL       | const | PRIMARY       | PRIMARY | 8       | const |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
1 row in set, 1 warning (0.00 sec)</code></pre>

<p>输出结果中包含以下要素。</p>
<ul>
<li><code>id</code>：查询标识号。</li>
<li><code>select_type</code>：查询类型。</li>
<li><code>table</code>：表。</li>
<li><code>partitions</code>：分区信息。</li>
<li><code>type</code>：连接类型。</li>
<li><code>possible_keys</code>：可能用到的索引。</li>
<li><code>key</code>：使用的索引。</li>
<li><code>key_len</code>：使用的索引的长度。</li>
<li><code>ref</code>：关联的索引列。</li>
<li><code>rows</code>：预估扫描行数。</li>
<li><code>filtered</code>：过滤百分比。</li>
<li><code>Extra</code>：额外信息。</li>
</ul>
<h3 id="select-type">2.2. select_type</h3><p>查询类型<code>select_type</code>有以下几种：</p>
<ul>
<li><code>SIMPLE</code>：简单查询（不包括联合查询或子查询）。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user where id &#x3D; 1;
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | user  | NULL       | const | PRIMARY       | PRIMARY | 8       | const |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
1 row in set, 1 warning (0.00 sec)</code></pre>

<ul>
<li><code>PRIMARY</code>：复杂查询最外层的查询。</li>
<li><code>UNION</code>：联合查询。</li>
<li><code>UNION RESULT</code>：联合查询的结果。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user t where t.id in (select a.id from user a where id &#x3D; 1 union select b.id from user b where salary &gt; 100);
+----+--------------------+------------+------------+--------+---------------+---------+---------+-------+--------+----------+-----------------+
| id | select_type        | table      | partitions | type   | possible_keys | key     | key_len | ref   | rows   | filtered | Extra           |
+----+--------------------+------------+------------+--------+---------------+---------+---------+-------+--------+----------+-----------------+
|  1 | PRIMARY            | t          | NULL       | ALL    | NULL          | NULL    | NULL    | NULL  | 989600 |   100.00 | Using where     |
|  2 | DEPENDENT SUBQUERY | a          | NULL       | const  | PRIMARY       | PRIMARY | 8       | const |      1 |   100.00 | Using index     |
|  3 | DEPENDENT UNION    | b          | NULL       | eq_ref | PRIMARY       | PRIMARY | 8       | func  |      1 |    33.33 | Using where     |
|  4 | UNION RESULT       | &lt;union2,3&gt; | NULL       | ALL    | NULL          | NULL    | NULL    | NULL  |   NULL |     NULL | Using temporary |
+----+--------------------+------------+------------+--------+---------------+---------+---------+-------+--------+----------+-----------------+
4 rows in set, 1 warning (0.00 sec)</code></pre>

<ul>
<li><code>SUBQUERY</code>：简单子查询。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select t.salary - (select avg(salary) from user) from user t where t.id &#x3D; 1;
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+--------+----------+-------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref   | rows   | filtered | Extra |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+--------+----------+-------+
|  1 | PRIMARY     | t     | NULL       | const | PRIMARY       | PRIMARY | 8       | const |      1 |   100.00 | NULL  |
|  2 | SUBQUERY    | user  | NULL       | ALL   | NULL          | NULL    | NULL    | NULL  | 989600 |   100.00 | NULL  |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+--------+----------+-------+
2 rows in set, 1 warning (0.00 sec)</code></pre>

<ul>
<li><code>DERIVED</code>：派生表。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select b.id, b.salary - a.salary from (select t.job, avg(t.salary) as salary from user t group by t.job) a, user b where a.job &#x3D;
b.job;
+----+-------------+------------+------------+-------+---------------+-------------+---------+------------+--------+----------+-------------+
| id | select_type | table      | partitions | type  | possible_keys | key         | key_len | ref        | rows   | filtered | Extra       |
+----+-------------+------------+------------+-------+---------------+-------------+---------+------------+--------+----------+-------------+
|  1 | PRIMARY     | b          | NULL       | ALL   | idx_job       | NULL        | NULL    | NULL       | 989600 |   100.00 | Using where |
|  1 | PRIMARY     | &lt;derived2&gt; | NULL       | ref   | &lt;auto_key0&gt;   | &lt;auto_key0&gt; | 403     | test.b.job |     10 |   100.00 | NULL        |
|  2 | DERIVED     | t          | NULL       | index | idx_job       | idx_job     | 403     | NULL       | 989600 |   100.00 | NULL        |
+----+-------------+------------+------------+-------+---------------+-------------+---------+------------+--------+----------+-------------+
3 rows in set, 1 warning (0.00 sec)</code></pre>

<ul>
<li><code>DEPENDENT UNION</code>：依赖联合查询。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user t where t.id in (select a.id from user a where a.id &#x3D; 1 union select min(b.id) from user b where b.balance &gt; t.balance);
+----+--------------------+------------+------------+-------+---------------+---------+---------+-------+--------+----------+-----------------+
| id | select_type        | table      | partitions | type  | possible_keys | key     | key_len | ref   | rows   | filtered | Extra           |
+----+--------------------+------------+------------+-------+---------------+---------+---------+-------+--------+----------+-----------------+
|  1 | PRIMARY            | t          | NULL       | ALL   | NULL          | NULL    | NULL    | NULL  | 985889 |   100.00 | Using where     |
|  2 | DEPENDENT SUBQUERY | a          | NULL       | const | PRIMARY       | PRIMARY | 8       | const |      1 |   100.00 | Using index     |
|  3 | DEPENDENT UNION    | b          | NULL       | ALL   | NULL          | NULL    | NULL    | NULL  | 985889 |    33.33 | Using where     |
|  4 | UNION RESULT       | &lt;union2,3&gt; | NULL       | ALL   | NULL          | NULL    | NULL    | NULL  |   NULL |     NULL | Using temporary |
+----+--------------------+------------+------------+-------+---------------+---------+---------+-------+--------+----------+-----------------+
4 rows in set, 2 warnings (0.00 sec)</code></pre>

<ul>
<li><code>DEPENDENT SUBQUERY</code>：依赖子查询。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select a.id, (select count(b.id) from user b where b.salary &gt; a.salary) from user a where id &#x3D; 1;
+----+--------------------+-------+------------+-------+---------------+---------+---------+-------+--------+----------+-------------+
| id | select_type        | table | partitions | type  | possible_keys | key     | key_len | ref   | rows   | filtered | Extra       |
+----+--------------------+-------+------------+-------+---------------+---------+---------+-------+--------+----------+-------------+
|  1 | PRIMARY            | a     | NULL       | const | PRIMARY       | PRIMARY | 8       | const |      1 |   100.00 | NULL        |
|  2 | DEPENDENT SUBQUERY | b     | NULL       | ALL   | NULL          | NULL    | NULL    | NULL  | 989600 |    33.33 | Using where |
+----+--------------------+-------+------------+-------+---------------+---------+---------+-------+--------+----------+-------------+
2 rows in set, 2 warnings (0.00 sec)</code></pre>

<h3 id="type">2.3. type</h3><p>连接类型<code>type</code>有以下几种类型：</p>
<ul>
<li><code>system</code>：表中只有一行。</li>
<li><code>const</code>：使用唯一索引或主键索引等值查询。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user where id &#x3D; 1;
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | user  | NULL       | const | PRIMARY       | PRIMARY | 8       | const |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
1 row in set, 1 warning (0.00 sec)</code></pre>

<ul>
<li><code>eq_ref</code>：使用唯一索引或主键索引作为连接查询的条件。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select a.* from user a, user b where a.id &#x3D; b.id;
+----+-------------+-------+------------+--------+---------------+---------+---------+-----------+--------+----------+-------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref       | rows   | filtered | Extra       |
+----+-------------+-------+------------+--------+---------------+---------+---------+-----------+--------+----------+-------------+
|  1 | SIMPLE      | a     | NULL       | ALL    | PRIMARY       | NULL    | NULL    | NULL      | 985889 |   100.00 | NULL        |
|  1 | SIMPLE      | b     | NULL       | eq_ref | PRIMARY       | PRIMARY | 8       | test.a.id |      1 |   100.00 | Using index |
+----+-------------+-------+------------+--------+---------------+---------+---------+-----------+--------+----------+-------------+
2 rows in set, 1 warning (0.00 sec)</code></pre>

<ul>
<li><code>ref</code>：使用非唯一索引等值查询。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user where job &#x3D; &#39;工程师&#39;;
+----+-------------+-------+------------+------+---------------+---------+---------+-------+------+----------+-------+
| id | select_type | table | partitions | type | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------------+------+---------------+---------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | user  | NULL       | ref  | idx_job       | idx_job | 403     | const |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+------+---------------+---------+---------+-------+------+----------+-------+
1 row in set, 1 warning (0.03 sec)</code></pre>

<ul>
<li><code>ref_or_null</code>：使用唯一索引等值查询，且允许列为空。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user where job &#x3D; &#39;工程师&#39; or job is null;
+----+-------------+-------+------------+-------------+---------------+---------+---------+-------+------+----------+-----------------------+
| id | select_type | table | partitions | type        | possible_keys | key     | key_len | ref   | rows | filtered | Extra                 |
+----+-------------+-------+------------+-------------+---------------+---------+---------+-------+------+----------+-----------------------+
|  1 | SIMPLE      | user  | NULL       | ref_or_null | idx_job       | idx_job | 403     | const |    2 |   100.00 | Using index condition |
+----+-------------+-------+------------+-------------+---------------+---------+---------+-------+------+----------+-----------------------+
1 row in set, 1 warning (0.01 sec)
</code></pre>

<ul>
<li><code>range</code>：使用索引范围查询。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user where id &gt; 80;
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows   | filtered | Extra       |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | range | PRIMARY       | PRIMARY | 8       | NULL | 492944 |   100.00 | Using where |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
1 row in set, 1 warning (0.00 sec)

mysql&gt; explain select * from user where id in (1, 2, 3);
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra       |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | range | PRIMARY       | PRIMARY | 8       | NULL |    3 |   100.00 | Using where |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
1 row in set, 1 warning (0.00 sec)

mysql&gt; explain select * from user where job like &#39;工%&#39;;
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-----------------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra                 |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-----------------------+
|  1 | SIMPLE      | user  | NULL       | range | idx_job       | idx_job | 403     | NULL | 2016 |   100.00 | Using index condition |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-----------------------+
1 row in set, 1 warning (0.04 sec)</code></pre>

<ul>
<li><code>index_merge</code>：使用索引合并，同时使用多个索引。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user where id &gt; 10 or job &#x3D; &#39;工程师&#39;;
+----+-------------+-------+------------+-------------+-----------------+-----------------+---------+------+--------+----------+-------------------------------------------+
| id | select_type | table | partitions | type        | possible_keys   | key             | key_len | ref  | rows   | filtered | Extra                                     |
+----+-------------+-------+------------+-------------+-----------------+-----------------+---------+------+--------+----------+-------------------------------------------+
|  1 | SIMPLE      | user  | NULL       | index_merge | PRIMARY,idx_job | PRIMARY,idx_job | 8,403   | NULL | 492945 |   100.00 | Using union(PRIMARY,idx_job); Using where |
+----+-------------+-------+------------+-------------+-----------------+-----------------+---------+------+--------+----------+-------------------------------------------+
1 row in set, 1 warning (0.03 sec)</code></pre>

<ul>
<li><code>index</code>：对二级索引树进行扫描。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select job from user;
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows   | filtered | Extra       |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | index | NULL          | idx_job | 403     | NULL | 985889 |   100.00 | Using index |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
1 row in set, 1 warning (0.00 sec)</code></pre>

<ul>
<li><code>all</code>：对主键索引树进行全表扫描。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user where job like &#39;%人&#39;;
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows   | filtered | Extra       |
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 985889 |    11.11 | Using where |
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------------+
1 row in set, 1 warning (0.01 sec)</code></pre>

<h3 id="filtered">2.4. filtered</h3><p><code>row</code>列代表满足索引扫描条件的预估扫描行数，而<code>filtered</code>代表满足搜索条件的行数占预估扫描行数的比值。</p>
<h3 id="Extra">2.5. Extra</h3><ul>
<li><code>Using filesort</code>：使用文件排序。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user where id &gt; 10 order by salary desc limit 0, 10;
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-----------------------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows   | filtered | Extra                       |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-----------------------------+
|  1 | SIMPLE      | user  | NULL       | range | PRIMARY       | PRIMARY | 8       | NULL | 494800 |   100.00 | Using where; Using filesort |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-----------------------------+
1 row in set, 1 warning (0.00 sec)</code></pre>

<ul>
<li><code>Using where</code>：在服务层进行过滤。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user where id &gt; 10 and salary &gt; 2000;
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows   | filtered | Extra       |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | range | PRIMARY       | PRIMARY | 8       | NULL | 494800 |    33.33 | Using where |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
1 row in set, 1 warning (0.00 sec)</code></pre>

<ul>
<li><code>Using index</code>：使用覆盖索引</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select country, city from user where country &#x3D; &#39;中华人民共和国&#39;;
+----+-------------+-------+------------+------+------------------+------------------+---------+-------+------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys    | key              | key_len | ref   | rows | filtered | Extra       |
+----+-------------+-------+------------+------+------------------+------------------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | ref  | idx_country_city | idx_country_city | 403     | const |    1 |   100.00 | Using index |
+----+-------------+-------+------------+------+------------------+------------------+---------+-------+------+----------+-------------+
1 row in set, 1 warning (0.00 sec)</code></pre>

<ul>
<li><code>Using index condition</code>：使用索引条件下推。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user where country like &#39;中华人民共和国%&#39; and city &#x3D; &#39;贵州省&#39;;
+----+-------------+-------+------------+-------+------------------+------------------+---------+------+------+----------+-----------------------+
| id | select_type | table | partitions | type  | possible_keys    | key              | key_len | ref  | rows | filtered | Extra                 |
+----+-------------+-------+------------+-------+------------------+------------------+---------+------+------+----------+-----------------------+
|  1 | SIMPLE      | user  | NULL       | range | idx_country_city | idx_country_city | 806     | NULL |    1 |    10.00 | Using index condition |
+----+-------------+-------+------------+-------+------------------+------------------+---------+------+------+----------+-----------------------+
1 row in set, 1 warning (0.01 sec)</code></pre>

<ul>
<li><code>Using union</code>：使用索引合并。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; explain select * from user where id &gt; 10 or job &#x3D; &#39;工程师&#39;;
+----+-------------+-------+------------+-------------+-----------------+-----------------+---------+------+--------+----------+-------------------------------------------+
| id | select_type | table | partitions | type        | possible_keys   | key             | key_len | ref  | rows   | filtered | Extra                                     |
+----+-------------+-------+------------+-------------+-----------------+-----------------+---------+------+--------+----------+-------------------------------------------+
|  1 | SIMPLE      | user  | NULL       | index_merge | PRIMARY,idx_job | PRIMARY,idx_job | 8,403   | NULL | 494801 |   100.00 | Using union(PRIMARY,idx_job); Using where |
+----+-------------+-------+------------+-------------+-----------------+-----------------+---------+------+--------+----------+-------------------------------------------+
1 row in set, 1 warning (0.00 sec)</code></pre>

<h2 id="SQL语句优化案例分析">3. SQL语句优化案例分析</h2><h3 id="查询优化">3.1. 查询优化</h3><h4 id="使用具体字段代替select">3.1.1. 使用具体字段代替select *</h4><p>在业务允许的情况下建议使用<code>select &lt;具体字段&gt;</code>代替<code>select *</code>，有以下优点：</p>
<ul>
<li>只查询需要的字段，能够减少网络IO。</li>
<li>可以使用覆盖索引，避免回表。</li>
</ul>
<p>如下示例：</p>
<ul>
<li>第一条查询语句：使用范围扫描区间在主键索引树上扫描，并返回满足条件的前100条完整记录，对应<code>type</code>列的<code>range</code>。</li>
<li>第二条查询语句：使用范围扫描区间在主键索引树上扫描，并返回满足条件的前100条<code>id</code>，对应<code>type</code>列的<code>range</code>。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; &#x2F;**Q1**&#x2F;explain select * from user where id &gt; 10000 limit 100;
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows   | filtered | Extra       |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | range | PRIMARY       | PRIMARY | 8       | NULL | 493563 |   100.00 | Using where |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
1 row in set, 1 warning (0.00 sec)
mysql&gt; &#x2F;**Q2**&#x2F;explain select id from user where id &gt; 10000 limit 100;
+----+-------------+-------+------------+-------+--------------------------------------------------+---------+---------+------+--------+----------+--------------------------+
| id | select_type | table | partitions | type  | possible_keys                                    | key     | key_len | ref  | rows   | filtered | Extra                    |
+----+-------------+-------+------------+-------+--------------------------------------------------+---------+---------+------+--------+----------+--------------------------+
|  1 | SIMPLE      | user  | NULL       | range | PRIMARY,idx_job,idx_country_city,idx_create_time | PRIMARY | 8       | NULL | 493563 |   100.00 | Using where; Using index |
+----+-------------+-------+------------+-------+--------------------------------------------------+---------+---------+------+--------+----------+--------------------------+
1 row in set, 1 warning (0.00 sec)</code></pre>

<p><a href="/post/2443049666/rt-select.png" title="测试结果-使用具体字段代替select *" class="gallery-item"><img src="/post/2443049666/rt-select.png" alt="测试结果-使用具体字段代替select *"></a></p>
<h4 id="使用union-all代替union">3.1.2. 使用union all代替union</h4><p>在业务允许的情况下建议使用<code>union all</code>代替<code>union</code>，能够避免对结果集去重，以提高查询速度。如下示例：</p>
<ul>
<li>第一条查询语句：使用临时表对结果集去重，对应<code>Extra</code>列中的<code>Using temporary</code>。</li>
<li>第二条查询语句：无需使用临时表。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; &#x2F;**Q1**&#x2F;explain select count(*) from (select * from user where id &gt; 1000 and id &lt; 4000 union select * from user where id &gt; 4000 and id &lt; 8000) t; 
+----+--------------+------------+------------+-------+---------------+---------+---------+------+-------+----------+-----------------+
| id | select_type  | table      | partitions | type  | possible_keys | key     | key_len | ref  | rows  | filtered | Extra           |
+----+--------------+------------+------------+-------+---------------+---------+---------+------+-------+----------+-----------------+
|  1 | PRIMARY      | &lt;derived2&gt; | NULL       | ALL   | NULL          | NULL    | NULL    | NULL | 13972 |   100.00 | NULL            |
|  2 | DERIVED      | user       | NULL       | range | PRIMARY       | PRIMARY | 8       | NULL |  5832 |   100.00 | Using where     |
|  3 | UNION        | user       | NULL       | range | PRIMARY       | PRIMARY | 8       | NULL |  8140 |   100.00 | Using where     |
|  4 | UNION RESULT | &lt;union2,3&gt; | NULL       | ALL   | NULL          | NULL    | NULL    | NULL |  NULL |     NULL | Using temporary |
+----+--------------+------------+------------+-------+---------------+---------+---------+------+-------+----------+-----------------+
4 rows in set, 1 warning (0.00 sec)
mysql&gt; &#x2F;**Q2**&#x2F;explain select count(*) from (select * from user where id &gt; 1000 and id &lt; 4000 union all select * from user where id &gt; 4000 and id &lt; 8000) t;
+----+-------------+------------+------------+-------+---------------+---------+---------+------+-------+----------+-------------+
| id | select_type | table      | partitions | type  | possible_keys | key     | key_len | ref  | rows  | filtered | Extra       |
+----+-------------+------------+------------+-------+---------------+---------+---------+------+-------+----------+-------------+
|  1 | PRIMARY     | &lt;derived2&gt; | NULL       | ALL   | NULL          | NULL    | NULL    | NULL | 13972 |   100.00 | NULL        |
|  2 | DERIVED     | user       | NULL       | range | PRIMARY       | PRIMARY | 8       | NULL |  5832 |   100.00 | Using where |
|  3 | UNION       | user       | NULL       | range | PRIMARY       | PRIMARY | 8       | NULL |  8140 |   100.00 | Using where |
+----+-------------+------------+------------+-------+---------------+---------+---------+------+-------+----------+-------------+
3 rows in set, 1 warning (0.00 sec)</code></pre>

<p><a href="/post/2443049666/rt-union.png" title="测试结果-使用union all代替union" class="gallery-item"><img src="/post/2443049666/rt-union.png" alt="测试结果-使用union all代替union"></a></p>
<h4 id="避免索引失效导致全表扫描">3.1.3. 避免索引失效导致全表扫描</h4><p>索引可以提高数据查询的速度，而当索引失效时，可能会导致全表扫描。如下示例：</p>
<ul>
<li>第一条查询语句：对<code>id</code>索引列进行了计算导致索引失效，使用全表扫描进行查询，对应<code>type</code>列中的<code>ALL</code>。</li>
<li>第二条查询语句：使用<code>id</code>在主键索引树上进行等值查询，对应<code>type</code>列中的<code>const</code>。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; &#x2F;**Q1**&#x2F;explain select * from user where id + 1 &#x3D; 10;
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows   | filtered | Extra       |
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 987126 |   100.00 | Using where |
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-------------+
1 row in set, 1 warning (0.00 sec)
mysql&gt; &#x2F;**Q2**&#x2F;explain select * from user where id &#x3D; 9;
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | user  | NULL       | const | PRIMARY       | PRIMARY | 8       | const |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
1 row in set, 1 warning (0.01 sec)</code></pre>

<p><a href="/post/2443049666/rt-index-valid.png" title="测试结果-避免索引失效" class="gallery-item"><img src="/post/2443049666/rt-index-valid.png" alt="测试结果-避免索引失效"></a></p>
<h4 id="使用索引提高order-by的效率">3.1.4. 使用索引提高order by的效率</h4><p>使用索引列进行排序时，可以利用索引数据结构本身的有序性，无需使用文件排序。如下示例：</p>
<ul>
<li>第一条查询语句：使用非索引列<code>modify_time</code>进行排序，使用了文件排序，对应<code>Extra</code>列中的<code>Using filesort</code>。</li>
<li>第二条查询语句：使用索引列<code>create_time</code>进行排序，无需使用文件排序。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; &#x2F;**Q1**&#x2F;explain select * from user order by modify_time desc limit 100, 10;
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+----------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows   | filtered | Extra          |
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+----------------+
|  1 | SIMPLE      | user  | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 987126 |   100.00 | Using filesort |
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+----------------+
1 row in set, 1 warning (0.00 sec)
mysql&gt; &#x2F;**Q2**&#x2F;explain select * from user order by create_time desc limit 100, 10;
+----+-------------+-------+------------+-------+---------------+-----------------+---------+------+------+----------+---------------------+
| id | select_type | table | partitions | type  | possible_keys | key             | key_len | ref  | rows | filtered | Extra               |
+----+-------------+-------+------------+-------+---------------+-----------------+---------+------+------+----------+---------------------+
|  1 | SIMPLE      | user  | NULL       | index | NULL          | idx_create_time | 6       | NULL |  110 |   100.00 | Backward index scan |
+----+-------------+-------+------------+-------+---------------+-----------------+---------+------+------+----------+---------------------+
1 row in set, 1 warning (0.00 sec)</code></pre>

<p><a href="/post/2443049666/rt-order-by.png" title="测试结果-使用索引提高order by的效率" class="gallery-item"><img src="/post/2443049666/rt-order-by.png" alt="测试结果-使用索引提高order by的效率"></a></p>
<h4 id="使用索引提高group-by的效率">3.1.5. 使用索引提高group by的效率</h4><p>使用索引列进行分组时，可以利用索引数据结构本身的有序性，可以连续地找到参与分组的记录，无需使用临时表。如下示例：</p>
<ul>
<li>第一条查询语句：使用非索引列<code>salary</code>进行分组，使用了临时表，对应<code>Extra</code>列中的<code>Using temporary</code>。</li>
<li>第二条查询语句：使用索引列<code>job</code>进行分组，无需使用临时表。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; &#x2F;**Q1**&#x2F;explain select salary, count(*) from user group by salary;
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows   | filtered | Extra           |
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------+
|  1 | SIMPLE      | user  | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 987126 |   100.00 | Using temporary |
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------+
1 row in set, 1 warning (0.00 sec)
mysql&gt; &#x2F;**Q2**&#x2F;explain select job, count(*) from user group by job;
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows   | filtered | Extra       |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | index | idx_job       | idx_job | 403     | NULL | 987126 |   100.00 | Using index |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
1 row in set, 1 warning (0.00 sec)</code></pre>

<p><a href="/post/2443049666/rt-group-by.png" title="测试结果-使用索引提高group by的效率" class="gallery-item"><img src="/post/2443049666/rt-group-by.png" alt="测试结果-使用索引提高group by的效率"></a></p>
<h3 id="连接优化">3.2. 连接优化</h3><h4 id="join使用小表驱动大表">3.2.1. join使用小表驱动大表</h4><p>连接查询的耗时计算规则如下：</p>
<p>连接查询耗时 &#x3D; 在驱动表查询一次的耗时 + 驱动表查询结果集的行数 * 在被驱动表查询一次的耗时</p>
<p>当使用连接查询时，建议使用小表驱动大表以获得更快的查询速度，如下示例：</p>
<ul>
<li>第一条查询语句：使用大表<code>b</code>驱动小表<code>a</code></li>
<li>第二条查询语句：使用小表<code>a</code>驱动大表<code>b</code>。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; &#x2F;**Q1**&#x2F;explain select count(*) from user b straight_join user a on a.id &#x3D; b.id where a.salary &gt; 5000 and b.salary &gt; 1; 
+----+-------------+-------+------------+--------+---------------+---------+---------+-----------+--------+----------+-------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref       | rows   | filtered | Extra       |
+----+-------------+-------+------------+--------+---------------+---------+---------+-----------+--------+----------+-------------+
|  1 | SIMPLE      | b     | NULL       | ALL    | PRIMARY       | NULL    | NULL    | NULL      | 987126 |    33.33 | Using where |
|  1 | SIMPLE      | a     | NULL       | eq_ref | PRIMARY       | PRIMARY | 8       | test.b.id |      1 |    33.33 | Using where |
+----+-------------+-------+------------+--------+---------------+---------+---------+-----------+--------+----------+-------------+
2 rows in set, 1 warning (0.00 sec)
mysql&gt; &#x2F;**Q2**&#x2F;explain select count(*) from user a straight_join user b on a.id &#x3D; b.id where a.salary &gt; 5000 and b.salary &gt; 1; 
+----+-------------+-------+------------+--------+---------------+---------+---------+-----------+--------+----------+-------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref       | rows   | filtered | Extra       |
+----+-------------+-------+------------+--------+---------------+---------+---------+-----------+--------+----------+-------------+
|  1 | SIMPLE      | a     | NULL       | ALL    | PRIMARY       | NULL    | NULL    | NULL      | 987126 |    33.33 | Using where |
|  1 | SIMPLE      | b     | NULL       | eq_ref | PRIMARY       | PRIMARY | 8       | test.a.id |      1 |    33.33 | Using where |
+----+-------------+-------+------------+--------+---------------+---------+---------+-----------+--------+----------+-------------+
2 rows in set, 1 warning (0.01 sec)</code></pre>

<p><a href="/post/2443049666/rt-join.png" title="测试结果-join使用小表驱动大表" class="gallery-item"><img src="/post/2443049666/rt-join.png" alt="测试结果-join使用小表驱动大表"></a></p>
<h4 id="join的表不宜过多">3.2.2. join的表不宜过多</h4><p>当使用连接查询时，建议参与连接的表不宜过多，避免产生过大的笛卡尔积。</p>
<h4 id="为join的关联条件建立索引">3.2.3. 为join的关联条件建立索引</h4><p>当使用连接查询时，建议为关联条件添加索引，使被驱动表可以使用<code>eq_ref</code>进行查询来提高查询的速度。</p>
<h3 id="业务优化">3.3. 业务优化</h3><h4 id="深分页优化">3.3.1. 深分页优化</h4><p>当使用<code>select * from &lt;table&gt; limit &lt;offset&gt;, &lt;row_count&gt;</code>编写分页查询语句时，随着页码的增大，查询速度会越来越慢，即深分页问题。导致深分页问题的原因是<code>limit</code>语句会查询<code>offset + row_count</code>条数据，并舍弃前<code>offset</code>条数据，再返回<code>row_count</code>条数据，意味着有<code>offset</code>条多余的回表。深分页问题有以下几种解决方法：</p>
<ul>
<li>在业务层面，限制用户的查询条件，如必须指定时间范围等。</li>
<li>采用禁止跳页上下页的方式，使用<code>select * from &lt;table&gt; where id &gt; &lt;id&gt; limit &lt;page_size&gt;</code>分页语句。</li>
<li>使用<code>select * from &lt;table&gt; a, (select id from &lt;table&gt; limit &lt;offset&gt;, &lt;row_count&gt;) b where a.id = b.id</code>分页语句用覆盖索引避免多余的回表。</li>
</ul>
<p>如下示例：</p>
<ul>
<li>第一条查询语句：存在深分页问题。</li>
<li>第二条查询语句：不存在深分页问题。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql&gt; &#x2F;**Q1**&#x2F;explain select * from user order by create_time desc limit 900000, 10;
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+----------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows   | filtered | Extra          |
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+----------------+
|  1 | SIMPLE      | user  | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 987126 |   100.00 | Using filesort |
+----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+----------------+
1 row in set, 1 warning (0.00 sec)
mysql&gt; &#x2F;**Q2**&#x2F;explain select * from user a, (select id from user order by create_time desc limit 900000, 10) b where a.id &#x3D; b.id;
+----+-------------+------------+------------+--------+---------------+-----------------+---------+------+--------+----------+----------------------------------+
| id | select_type | table      | partitions | type   | possible_keys | key             | key_len | ref  | rows   | filtered | Extra                            |
+----+-------------+------------+------------+--------+---------------+-----------------+---------+------+--------+----------+----------------------------------+
|  1 | PRIMARY     | &lt;derived2&gt; | NULL       | ALL    | NULL          | NULL            | NULL    | NULL | 900010 |   100.00 | NULL                             |
|  1 | PRIMARY     | a          | NULL       | eq_ref | PRIMARY       | PRIMARY         | 8       | b.id |      1 |   100.00 | NULL                             |
|  2 | DERIVED     | user       | NULL       | index  | NULL          | idx_create_time | 6       | NULL | 900010 |   100.00 | Backward index scan; Using index |
+----+-------------+------------+------------+--------+---------------+-----------------+---------+------+--------+----------+----------------------------------+
3 rows in set, 1 warning (0.01 sec)</code></pre>
<p><a href="/post/2443049666/rt-deep-page.png" title="测试结果-深分页优化" class="gallery-item"><img src="/post/2443049666/rt-deep-page.png" alt="测试结果-深分页优化"></a></p>
<h2 id="参考文档">4. 参考文档</h2><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html">MySQL :: MySQL 8.0 Reference Manual :: 10.8.2 EXPLAIN Output Format</a><a href="#fnref:1" rev="footnote"> ↩</a></span></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">2.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/statement-optimization.html">MySQL :: MySQL 8.0 Reference Manual :: 10.2 Optimizing SQL Statements</a><a href="#fnref:2" rev="footnote"> ↩</a></span></li></ol></div></div></div><script src></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
</div>
  <hr/>
  <div class="article-footer">
    <a href="/post/4092758909/">上一篇：MySQL数据库如何调优？</a>
    <a href="/post/797218127/">下一篇：Spring应用是如何启动的？</a>
  </div>
  <div class="toc-pin">
  <h4>目录</h4>
  <hr>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">1. 背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%BC%98%E5%8C%96SQL%E8%AF%AD%E5%8F%A5%EF%BC%9F"><span class="toc-text">1.1. 为什么需要优化SQL语句？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9A%E4%BD%8D%E5%B9%B6%E4%BC%98%E5%8C%96%E6%85%A2%E7%9A%84SQL%E8%AF%AD%E5%8F%A5%EF%BC%9F"><span class="toc-text">1.2. 如何定位并优化慢的SQL语句？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">1.3. 环境准备</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-text">2. 执行计划</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8BSQL%E8%AF%AD%E5%8F%A5%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%EF%BC%9F"><span class="toc-text">2.1. 如何查看SQL语句的执行计划？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#select-type"><span class="toc-text">2.2. select_type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#type"><span class="toc-text">2.3. type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filtered"><span class="toc-text">2.4. filtered</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Extra"><span class="toc-text">2.5. Extra</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL%E8%AF%AD%E5%8F%A5%E4%BC%98%E5%8C%96%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-text">3. SQL语句优化案例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-text">3.1. 查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%85%B7%E4%BD%93%E5%AD%97%E6%AE%B5%E4%BB%A3%E6%9B%BFselect"><span class="toc-text">3.1.1. 使用具体字段代替select *</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8union-all%E4%BB%A3%E6%9B%BFunion"><span class="toc-text">3.1.2. 使用union all代替union</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%AF%BC%E8%87%B4%E5%85%A8%E8%A1%A8%E6%89%AB%E6%8F%8F"><span class="toc-text">3.1.3. 避免索引失效导致全表扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E6%8F%90%E9%AB%98order-by%E7%9A%84%E6%95%88%E7%8E%87"><span class="toc-text">3.1.4. 使用索引提高order by的效率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E6%8F%90%E9%AB%98group-by%E7%9A%84%E6%95%88%E7%8E%87"><span class="toc-text">3.1.5. 使用索引提高group by的效率</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E4%BC%98%E5%8C%96"><span class="toc-text">3.2. 连接优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#join%E4%BD%BF%E7%94%A8%E5%B0%8F%E8%A1%A8%E9%A9%B1%E5%8A%A8%E5%A4%A7%E8%A1%A8"><span class="toc-text">3.2.1. join使用小表驱动大表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#join%E7%9A%84%E8%A1%A8%E4%B8%8D%E5%AE%9C%E8%BF%87%E5%A4%9A"><span class="toc-text">3.2.2. join的表不宜过多</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BAjoin%E7%9A%84%E5%85%B3%E8%81%94%E6%9D%A1%E4%BB%B6%E5%BB%BA%E7%AB%8B%E7%B4%A2%E5%BC%95"><span class="toc-text">3.2.3. 为join的关联条件建立索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%BC%98%E5%8C%96"><span class="toc-text">3.3. 业务优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96"><span class="toc-text">3.3.1. 深分页优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-text">4. 参考文档</span></a></li></ol>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var navLinks = document.querySelectorAll('.toc-pin a');
      if (!navLinks) {
        return
      }
      var sectionIds = []
      navLinks.forEach(function(link) {
        sectionIds.push(decodeURIComponent(link.hash).substring(1))
      });
      window.addEventListener('scroll', function() {
        var currentPosition = window.scrollY || window.pageYOffset;
        sectionIds.forEach(function(id) {
          var section = document.querySelector('#' + id);
          var navLink = document.querySelector('.toc-pin a[href="#' + encodeURIComponent(id) + '"]');
          if (section && currentPosition >= (section.offsetTop - 60)) {
            navLinks.forEach(function(link) {
              link.classList.remove('highlight');
            });
            navLink.classList.add('highlight');
            if (navLinks[0] === navLink) {
              document.querySelector('.toc-pin h4').scrollIntoView();
            } else {
              navLink.scrollIntoView()
            }
          }
        });
      });
    });
  </script>
</div>
  <img class="article-to-toc" title="打开目录" onclick="openOrCloseTocPin()" src="/img/maximize.svg"/>
  <script>
    function showToc(show) {
      localStorage.setItem('tocPinState', show ? '1' : '0')
      var tocPin = document.querySelectorAll('.toc-pin')[0];
      tocPin.style.display = show ? '' : 'none'
      var mainPost = document.querySelectorAll('.main-post')[0];
      mainPost.style.marginLeft = show ? '' : 'auto'
      mainPost.style.width = show ? '' : '60%'
      var articleToTocButton = document.querySelectorAll('.article-to-toc')[0];
      articleToTocButton.src = show ? '/img/maximize.svg' : '/img/minimize.svg'
      articleToTocButton.title = show ? '关闭目录' : '打开目录'
    }
    function openOrCloseTocPin() {
      const show = localStorage.getItem('tocPinState') === '0'
      showToc(show)
    }
    showToc(localStorage.getItem('tocPinState') != '0')
  </script>
</main>
    <footer>
  <div class="footer-info">
  <a>© 2024 徐梦旗</a> 
  | <a target="_blank" rel="noopener" href="https://github.com/mizoreyo/hexo-theme-insnow">Theme Insnow</a>
  | <a href="/console">控制台</a>
  | <a href="http://beian.miit.gov.cn/"; target=_blank>浙ICP备2021010658号-1</a>
  | <img src="/img/ghs.png" style="width:12px;margin: 0 0.4rem 0 0.4rem;"/><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33011802002272">浙公网安备 33011802002272号</a>
  | <a class="footer-i" href="" title="@remeio"><i class="iconfont icon-wechat"></i></a>
  <a class="footer-i" target="_blank" rel="noopener" href="https://github.com/remeio"><i class="iconfont icon-github-fill"></i></a>
  <a class="footer-i" href="mailto:2663479778@qq.com"><i class="iconfont icon-mail"></i></a>
</div>
</footer>
  </div>
</body>
</html>